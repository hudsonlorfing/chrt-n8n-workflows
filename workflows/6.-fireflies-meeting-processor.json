{
  "name": "6. Fireflies Meeting Processor",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fireflies-meeting",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 300],
      "webhookId": "fireflies-meeting"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ JSON.stringify({status: 'received', meetingId: $json.meetingId || $json.body?.meetingId || 'unknown'}) }}"
      },
      "name": "Respond OK",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [220, 300]
    },
    {
      "parameters": {
        "jsCode": "// Extract meetingId from Fireflies webhook payload\n// Fireflies sends: { meetingId, eventType, clientReferenceId }\nconst webhook = $input.first().json;\nconst body = webhook.body || webhook;\nconst meetingId = body.meetingId || body.meeting_id || body.id;\n\nif (!meetingId) {\n  throw new Error('No meetingId in webhook payload: ' + JSON.stringify(body).substring(0, 200));\n}\n\nconsole.log('Received Fireflies webhook for meeting:', meetingId);\n\nreturn [{ json: { meetingId, eventType: body.eventType || 'Transcription completed' } }];"
      },
      "name": "Extract Meeting ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.fireflies.ai/graphql",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ query: `{ transcript(id: \"${$json.meetingId}\") { id title date duration organizer_email participants sentences { speaker_name text } summary { overview } } }` }) }}",
        "options": {}
      },
      "name": "Fireflies: Fetch Transcript",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "E59l4LdE1u7lD39v",
          "name": "Fireflies API"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst transcript = response.data?.transcript;\n\nif (!transcript) {\n  const error = response.errors?.[0]?.message || 'Transcript not found';\n  throw new Error('Fireflies API error: ' + error);\n}\n\n// Build transcript text from sentences\nconst transcriptText = (transcript.sentences || []).map(s => `${s.speaker_name}: ${s.text}`).join('\\n');\n\n// Parse date (Fireflies uses milliseconds timestamp)\nconst dateMs = transcript.date || Date.now();\nconst dateStr = new Date(dateMs).toISOString().split('T')[0];\n\n// Duration is in minutes from Fireflies\nconst durationMins = Math.round(transcript.duration || 0);\n\n// Generate hash for deduplication\nconst hash = require('crypto').createHash('md5').update(transcript.id + transcript.title).digest('hex').substring(0, 8);\n\nconst title = transcript.title || 'Untitled Meeting';\nconst attendees = transcript.participants || [];\n\n// Extract person name from title\nlet personName = '';\nconst titleLower = title.toLowerCase();\nconst withMatch = title.match(/(?:with|w\\/|and|&|x)\\s+([A-Z][a-z]+(?:\\s+[A-Z][a-z]+)*)/i);\nif (withMatch) {\n  personName = withMatch[1].trim();\n} else {\n  // Try to get non-Hudson attendee\n  personName = attendees.find(a => !a.toLowerCase().includes('hudson')) || '';\n  // Clean up email to name\n  if (personName.includes('@')) {\n    personName = personName.split('@')[0].split('.').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(' ');\n  }\n}\nif (!personName) personName = title.replace(/^(?:chat|call|meeting|sync|1:1|1-1)\\s*/i, '').trim();\n\n// Detect workspace from title\nlet workspace = 'chrt';\nif (titleLower.includes('goodlux')) workspace = 'goodlux';\nelse if (titleLower.includes('shed') || titleLower.includes('shedpro')) workspace = 'shedpro';\nelse if (titleLower.includes('personal') || titleLower.includes('family')) workspace = 'personal';\n\n// Detect meeting type\nlet suggestedType = 'general';\nif (titleLower.includes('internal') || titleLower.includes('standup') || titleLower.includes('sync') || titleLower.includes('team')) {\n  suggestedType = 'internal';\n} else if (titleLower.includes('interview') || titleLower.includes('research') || titleLower.includes('discovery')) {\n  suggestedType = 'research';\n} else if (titleLower.includes('demo') || titleLower.includes('sales') || titleLower.includes('client') || titleLower.includes('customer')) {\n  suggestedType = 'sales';\n} else if (titleLower.includes('onboarding') || titleLower.includes('cfo') || titleLower.includes('kickoff')) {\n  suggestedType = 'internal';\n}\n\nconst safeTitle = title.replace(/[^a-zA-Z0-9 -]/g, '').trim().substring(0, 50);\nconst safePerson = (personName || 'General').replace(/[^a-zA-Z0-9 -]/g, '').trim();\nconst transcriptLength = transcriptText.length;\nconst estimatedTokens = Math.ceil(transcriptLength / 4);\n\nconst firefliesUrl = `https://app.fireflies.ai/view/${transcript.id}`;\n\nreturn [{ json: {\n  meetingId: transcript.id,\n  hash,\n  title,\n  personName,\n  safePerson,\n  date: new Date(dateMs).toISOString(),\n  dateStr,\n  duration: durationMins * 60,\n  durationMins,\n  attendees: attendees.join(', '),\n  transcript: transcriptText,\n  transcriptLength,\n  estimatedTokens,\n  workspace,\n  suggestedType,\n  safeTitle,\n  firefliesUrl,\n  summary: transcript.summary?.overview || ''\n} }];"
      },
      "name": "Process Transcript",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-transcript",
              "leftValue": "={{ $json.transcript.length }}",
              "rightValue": 50,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Has Valid Transcript?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://srv1230891.hstgr.cloud:3852/store",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ hash: $json.hash, meeting: $json }) }}",
        "options": {}
      },
      "name": "VPS: Store Meeting",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1320, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ SLACK_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ blocks: [ { type: 'header', text: { type: 'plain_text', text: 'üìù New Meeting Ready', emoji: true } }, { type: 'section', text: { type: 'mrkdwn', text: '*' + $('Process Transcript').first().json.title + '*\\nüë§ ' + ($('Process Transcript').first().json.personName || 'Unknown') + '\\n‚è±Ô∏è ' + $('Process Transcript').first().json.durationMins + ' min | ~' + $('Process Transcript').first().json.estimatedTokens + ' tokens\\n<' + $('Process Transcript').first().json.firefliesUrl + '|View in Fireflies>' } }, { type: 'input', block_id: 'workspace_block', element: { type: 'static_select', action_id: 'workspace_select', placeholder: { type: 'plain_text', text: 'Select workspace' }, initial_option: { text: { type: 'plain_text', text: $('Process Transcript').first().json.workspace }, value: $('Process Transcript').first().json.workspace }, options: [ { text: { type: 'plain_text', text: 'chrt' }, value: 'chrt' }, { text: { type: 'plain_text', text: 'goodlux' }, value: 'goodlux' }, { text: { type: 'plain_text', text: 'personal' }, value: 'personal' }, { text: { type: 'plain_text', text: 'shedpro' }, value: 'shedpro' } ] }, label: { type: 'plain_text', text: 'Workspace' } }, { type: 'input', block_id: 'meeting_type_block', element: { type: 'static_select', action_id: 'meeting_type_select', placeholder: { type: 'plain_text', text: 'Select meeting type' }, initial_option: { text: { type: 'plain_text', text: $('Process Transcript').first().json.suggestedType === 'sales' ? 'Sales/Client' : $('Process Transcript').first().json.suggestedType === 'internal' ? 'Internal' : $('Process Transcript').first().json.suggestedType === 'research' ? 'Research/Interview' : 'General' }, value: $('Process Transcript').first().json.suggestedType }, options: [ { text: { type: 'plain_text', text: 'Sales/Client' }, value: 'sales' }, { text: { type: 'plain_text', text: 'General' }, value: 'general' }, { text: { type: 'plain_text', text: 'Internal' }, value: 'internal' }, { text: { type: 'plain_text', text: 'Research/Interview' }, value: 'research' } ] }, label: { type: 'plain_text', text: 'Meeting Type' } }, { type: 'actions', block_id: 'actions_block', elements: [ { type: 'button', text: { type: 'plain_text', text: '‚úÖ Process Meeting', emoji: true }, style: 'primary', action_id: 'process_meeting', value: $('Process Transcript').first().json.hash } ] }, { type: 'context', elements: [{ type: 'mrkdwn', text: 'Hash: `' + $('Process Transcript').first().json.hash + '` | Type: ' + $('Process Transcript').first().json.suggestedType }] } ], text: 'New meeting: ' + $('Process Transcript').first().json.title }) }}",
        "options": {}
      },
      "name": "Slack: Interactive Form",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 100]
    },
    {
      "parameters": {},
      "name": "Invalid Transcript",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1320, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ SLACK_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ text: '‚ùå Fireflies API Error: ' + ($json.error || $json.errors?.[0]?.message || 'Unknown error') + '\\nMeeting ID: ' + $('Extract Meeting ID').first().json.meetingId }) }}",
        "options": {}
      },
      "name": "Slack: API Error",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 400]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "Respond OK", "type": "main", "index": 0}]]
    },
    "Respond OK": {
      "main": [[{"node": "Extract Meeting ID", "type": "main", "index": 0}]]
    },
    "Extract Meeting ID": {
      "main": [[{"node": "Fireflies: Fetch Transcript", "type": "main", "index": 0}]]
    },
    "Fireflies: Fetch Transcript": {
      "main": [
        [{"node": "Process Transcript", "type": "main", "index": 0}],
        [{"node": "Slack: API Error", "type": "main", "index": 0}]
      ]
    },
    "Process Transcript": {
      "main": [[{"node": "Has Valid Transcript?", "type": "main", "index": 0}]]
    },
    "Has Valid Transcript?": {
      "main": [
        [{"node": "VPS: Store Meeting", "type": "main", "index": 0}],
        [{"node": "Invalid Transcript", "type": "main", "index": 0}]
      ]
    },
    "VPS: Store Meeting": {
      "main": [[{"node": "Slack: Interactive Form", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "YWP69Qgq0ZlCN7Gj"
  }
}
